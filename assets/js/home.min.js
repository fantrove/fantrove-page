// ปุ่มดูทั้งหมด (View All) — เวอร์ชัน "ไม่มีอนิเมชั่น" และตัดชิ้นส่วนลูกศรออกทั้งหมด

const viewAllConfigs = {
  emoji: {
    url: "/data/verse/discover/?type=emojis",
    labels: { th: "ดูทั้งหมด", en: "View All" }
  },
  "special-characters": {
    url: "/data/verse/discover/?type=special-characters__&page=1",
    labels: { th: "ดูทั้งหมด", en: "View All" }
  }
};

function pickLang(obj, langList) {
  if (typeof obj !== 'object' || obj === null) return obj;
  for (const lang of langList) {
    if (obj[lang]) return obj[lang];
  }
  const keys = Object.keys(obj);
  return keys.length > 0 ? obj[keys[0]] : '';
}

function getViewAllLabel(typeId) {
  const lang = localStorage.getItem('selectedLang') || 'en';
  return viewAllConfigs[typeId]?.labels?.[lang] || viewAllConfigs[typeId]?.labels?.en || "View All";
}

function getViewAllUrl(typeId) {
  return viewAllConfigs[typeId]?.url || "#";
}

function getLoadDataErrorMessage(error) {
  const lang = localStorage.getItem('selectedLang') || 'en';
  const messages = {
    th: "เกิดข้อผิดพลาด: ไม่สามารถโหลดข้อมูลหรือเทมเพลตได้",
    en: "Error: Unable to load data or templates",
  };
  return `${messages[lang] || messages.en}<br><small style="color: #ff8a8a;">${error}</small>`;
}

async function copyToClipboard(content) {
  try {
    await navigator.clipboard.writeText(content);
    return true;
  } catch (e) {
    return false;
  }
}

async function initializeHomepage() {
  const app = document.getElementById('app');
  const jsonPath = '/assets/db/db.min.json';
  const templatePath = '/assets/template-html/home-templates.html';
  
  try {
    const [dataResponse, templateResponse] = await Promise.all([
      fetch(jsonPath),
      fetch(templatePath)
    ]);
    if (!dataResponse.ok) {
      throw new Error(`ไม่สามารถโหลดไฟล์ JSON ได้ (Status: ${dataResponse.status}) จาก: ${jsonPath}`);
    }
    if (!templateResponse.ok) {
      throw new Error(`ไม่สามารถโหลดไฟล์เทมเพลตได้ (Status: ${templateResponse.status}) จาก: ${templatePath}`);
    }
    const data = await dataResponse.json();
    const templateHTML = await templateResponse.text();
    const parser = new DOMParser();
    const templateDoc = parser.parseFromString(templateHTML, 'text/html');
    const mainTemplate = templateDoc.getElementById('home-main-template');
    const categoryTemplate = templateDoc.getElementById('home-category-template');
    const cardTemplate = templateDoc.getElementById('home-item-card-template');
    if (!mainTemplate || !categoryTemplate || !cardTemplate) {
      const missing = [
        !mainTemplate ? '#home-main-template' : null,
        !categoryTemplate ? '#home-category-template' : null,
        !cardTemplate ? '#home-item-card-template' : null
      ].filter(Boolean).join(', ');
      throw new Error(`หาเทมเพลตไม่เจอ! กรุณาตรวจสอบ ID: ${missing} ในไฟล์ home-templates.html`);
    }
    renderHomePage(data, { mainTemplate, categoryTemplate, cardTemplate });
  } catch (error) {
    app.innerHTML = `<p style="color:red; font-family: monospace;">${getLoadDataErrorMessage(error.message)}</p>`;
  }
}

function renderHomePage(database, templates) {
  const app = document.getElementById('app');
  app.innerHTML = '';
  if (!database.type || !Array.isArray(database.type)) {
    throw new Error("โครงสร้างข้อมูล JSON ไม่ถูกต้อง: ไม่พบ 'database.type'");
  }
  const { mainTemplate, categoryTemplate, cardTemplate } = templates;
  const userLang = localStorage.getItem('selectedLang') || 'en';
  const langList = [userLang, 'en'];
  database.type.forEach(typeObj => {
    const typeId = typeObj.id;
    const typeName = pickLang(typeObj.name, langList) || typeId;
    const categories = (typeObj.category || []).slice(0, 4);
    const mainClone = mainTemplate.content.cloneNode(true);
    const categoriesContainer = mainClone.querySelector('[data-ref="categories-container"]');
    mainClone.querySelector('[data-ref="type-name"]').textContent = typeName;
    const viewAllBtn = mainClone.querySelector('[data-ref="view-all-btn"]');
    
    // ตรวจสอบว่า viewAllBtn เป็น <a> หรือ <button> และแปลงให้เหมาะสม
    const url = getViewAllUrl(typeId);
    const viewAllBtnNew = createViewAllButton(viewAllBtn, typeId, url, userLang);
    
    // แทนที่ element เก่าด้วยอันใหม่
    viewAllBtn.replaceWith(viewAllBtnNew);
    
    categories.forEach(category => {
      const categoryClone = categoryTemplate.content.cloneNode(true);
      const track = categoryClone.querySelector('[data-ref="track"]');
      categoryClone.querySelector('[data-ref="category-name"]').textContent = pickLang(category.name, langList) || '';
      (category.data || []).forEach(item => {
        const cardClone = cardTemplate.content.cloneNode(true);
        const card = cardClone.querySelector('.item-card');
        const itemName = pickLang(item.name, langList) || item.api || '';
        cardClone.querySelector('[data-ref="item-text"]').textContent = item.text || '';
        cardClone.querySelector('[data-ref="item-name"]').textContent = itemName;
        card.title = `คัดลอก ${itemName}`;
        card.onclick = async () => {
          if (await copyToClipboard(item.text || '')) {
            if (typeof window.showCopyNotification === 'function') {
              window.showCopyNotification({
                text: item.text,
                name: itemName,
                typeId: typeId,
                lang: userLang
              });
            }
          }
        };
        track.appendChild(cardClone);
      });
      categoriesContainer.appendChild(categoryClone);
    });
    app.appendChild(mainClone);
  });
}

/**
 * สร้างปุ่ม View All (ไม่มีอนิเมชัน และไม่สร้าง DOM ของลูกศร/overlay)
 * คัดลอกแอตทริบิวต์ทั้งหมดจากต้นฉบับ (ยกเว้น id/data-ref)
 */
function createViewAllButton(originalElement, typeId, url, userLang) {
  let viewAllBtn;
  const origTag = originalElement.tagName ? originalElement.tagName.toUpperCase() : 'BUTTON';
  
  // สร้าง element ตามต้นฉบับ
  if (origTag === 'A') {
    viewAllBtn = document.createElement('a');
    viewAllBtn.setAttribute('href', url);
    viewAllBtn.setAttribute('role', 'button');
    viewAllBtn.setAttribute('aria-label', getViewAllLabel(typeId));
  } else {
    viewAllBtn = document.createElement('button');
    viewAllBtn.type = 'button';
    viewAllBtn.setAttribute('aria-label', getViewAllLabel(typeId));
  }
  
  // คัดลอกแอตทริบิวต์ทั้งหมดจากต้นฉบับ (ยกเว้น id และ data-ref)
  if (originalElement.attributes && originalElement.attributes.length) {
    for (let i = 0; i < originalElement.attributes.length; i++) {
      const attr = originalElement.attributes[i];
      const name = attr.name;
      const value = attr.value;
      if (name === 'id') continue; // ป้องกัน ID ซ้ำ
      if (name === 'data-ref') continue; // เราจะตั้ง data-ref เอง
      if (name === 'href' && origTag === 'A') {
        // ใช้ href จาก config (overwrite) — ลบเงื่อนไขนี้ถ้าต้องการเก็บ href ต้นฉบับ
        continue;
      }
      viewAllBtn.setAttribute(name, value);
    }
  }
  
  // ตั้ง data-ref ใหม่ (จำเป็นต่อการ query)
  viewAllBtn.setAttribute('data-ref', 'view-all-btn');
  if (!viewAllBtn.getAttribute('class') && originalElement.className) {
    viewAllBtn.className = originalElement.className;
  }
  if (!viewAllBtn.getAttribute('style') && originalElement.getAttribute('style')) {
    viewAllBtn.setAttribute('style', originalElement.getAttribute('style'));
  }
  
  // inner: เฉพาะเนื้อหาหลัก (no arrow/overlay elements)
  viewAllBtn.innerHTML = `<span class="btn-content">${getViewAllLabel(typeId)}</span>`;
  
  // จัดการ click event: ไม่มีอนิเมชั่น
  viewAllBtn.addEventListener('click', handleViewAllClick.bind(null, viewAllBtn, typeId, url), false);
  
  return viewAllBtn;
}

/**
 * ฟังก์ชันจัดการ click event แบบไม่มีอนิเมชั่น
 */
function handleViewAllClick(btn, typeId, url, e) {
  // สำหรับ <a> tag ให้ใช้ behavior ปกติ (ไม่ preventDefault) เพื่อให้ navigation ตาม href ทำงานทันที
  if (btn.tagName === 'A') {
    return;
  }
  
  // สำหรับ <button> ให้ไปที่ URL โดยตรง
  if (e && typeof e.preventDefault === 'function') e.preventDefault();
  if (url && url !== "#") {
    window.location.href = url;
  }
}

initializeHomepage();