/**
 * ModernNavigation v3.1 - Advanced Language-Aware Router (Fixed Syntax)
 * 
 * Features:
 * - Zero JSON changes required - Auto language detection & injection
 * - Smart URL Synthesis - Dynamic href generation based on current lang context
 * - Predictive Prefetching - Preload pages on hover/touchstart for instant navigation
 * - State Preservation - Maintains scroll position, query params, hash across lang switches
 * - SPA-like Transitions - Smooth page transitions without flicker
 * - History API Integration - Proper back/forward handling with lang state
 * - Multi-language Context Awareness - Detects lang from URL, localStorage, or browser
 * - SEO-First - Degrades gracefully for bots/no-js users
 */

/* --- [BEGIN: Wave Effect Loader] --- */
(function(){
  var waveScriptSrc = "https://marcumat-js.pages.dev/dist/wave-effect.js";
  if (!document.querySelector('script[src="' + waveScriptSrc + '"]')) {
    var script = document.createElement('script');
    script.src = waveScriptSrc;
    script.async = true;
    document.head.appendChild(script);
  }
})();
/* --- [END: Wave Effect Loader] --- */

class ModernNavigation {
  constructor(config) {
    // Ensure config is an object
    config = config || {};
    
    // Core config
    this.cssPath = config.cssPath || '/assets/css/modern-styles.min.css';
    this.configPath = config.configPath || '/assets/json/buttons.min.json';
    this.activeClass = config.activeClass || 'active-1';
    this.navItemSelector = config.navItemSelector || '.nav-item';
    this.defaultButtonClass = config.defaultButtonClass || 'default-button';
    this.leftRailWidth = config.leftRailWidth || '88px';
    this.leftRailCollapsedWidth = config.leftRailCollapsedWidth || '72px';

    // Language config
    this.defaultLang = config.defaultLang || 'en';
    this.supportedLangs = config.supportedLangs || ['en', 'th', 'ja', 'ko', 'zh', 'fr', 'de', 'es', 'it', 'pt', 'ru', 'ar', 'vi', 'id', 'ms', 'tl'];
    this.currentLang = this._detectCurrentLanguage();
    
    // Advanced routing config
    this.enablePrefetch = config.enablePrefetch !== false;
    this.prefetchDelay = config.prefetchDelay || 100;
    this.enableSmoothTransition = config.enableSmoothTransition !== false;
    this.transitionDuration = config.transitionDuration || 200;
    
    // State management
    this._initialized = false;
    this._config = null;
    this._navEl = null;
    this._isTouching = false;
    this._navVisible = true;
    this._lastScrollY = window.scrollY;
    this._rafId = null;
    this.SHOW_THRESHOLD = 40;
    this._externalHideRequested = false;
    this._autoScrollSyncEnabled = true;
    this._originalSetItem = localStorage.setItem.bind(localStorage);
    this._navScrollSyncEnabled = false;
    
    // Advanced routing state
    this._prefetchCache = new Map();
    this._navigationHistory = [];
    this._isNavigating = false;
    this._currentRouteContext = this._parseRouteContext(window.location.href);
    this._langSwitchInProgress = false;
    
    // Bind all methods
    this._resizeHandler = this._debounce(this._applyScreenBehavior.bind(this), 120);
    this._orientationHandler = this._applyScreenBehavior.bind(this);
    this._scrollHandler = this._onScrollForActiveState.bind(this);
    this._storageHandler = this._onStorageEvent.bind(this);
    this._onUltraScrollNavBound = this._onUltraScrollNav.bind(this);
    this._onTouchStartBound = this._onTouchStart.bind(this);
    this._onTouchEndBound = this._onTouchEnd.bind(this);
    this._onNavClickBound = this._onNavClick.bind(this);
    this._onExternalCommandBound = this._onExternalCommand.bind(this);
    this._onPopStateBound = this._onPopState.bind(this);
    this._onPrefetchHoverBound = this._onPrefetchHover.bind(this);
    this._onPrefetchTouchBound = this._onPrefetchTouch.bind(this);
  }

  /* ==================== LANGUAGE DETECTION & MANAGEMENT ==================== */

  _detectCurrentLanguage() {
    // Check URL path first
    var pathLang = this._extractLangFromPath(window.location.pathname);
    if (pathLang) {
      localStorage.setItem('selectedLang', pathLang);
      return pathLang;
    }
    
    // Check localStorage
    var storedLang = localStorage.getItem('selectedLang');
    if (storedLang && this.supportedLangs.indexOf(storedLang) !== -1) {
      return storedLang;
    }
    
    // Check HTML lang attribute
    var htmlLang = document.documentElement.lang;
    if (htmlLang) {
      var primaryLang = htmlLang.split('-')[0];
      if (this.supportedLangs.indexOf(primaryLang) !== -1) {
        return primaryLang;
      }
    }
    
    // Check browser preference
    var browserLang = navigator.language || navigator.userLanguage;
    if (browserLang) {
      var browserPrimaryLang = browserLang.split('-')[0];
      if (this.supportedLangs.indexOf(browserPrimaryLang) !== -1) {
        return browserPrimaryLang;
      }
    }
    
    return this.defaultLang;
  }

  _extractLangFromPath(path) {
    var segments = path.split('/').filter(function(s) { return s.length > 0; });
    if (segments.length > 0) {
      var potentialLang = segments[0].toLowerCase();
      if (this.supportedLangs.indexOf(potentialLang) !== -1) {
        return potentialLang;
      }
    }
    return null;
  }

  _parseRouteContext(url) {
    var parsed = document.createElement('a');
    parsed.href = url;
    var pathLang = this._extractLangFromPath(parsed.pathname);
    
    var cleanPath = parsed.pathname;
    if (pathLang) {
      var segments = parsed.pathname.split('/').filter(function(s) { return s.length > 0; });
      cleanPath = '/' + segments.slice(1).join('/');
      if (cleanPath === '/') cleanPath = '/';
    }
    
    return {
      fullUrl: url,
      pathname: parsed.pathname,
      cleanPath: cleanPath,
      lang: pathLang || this.currentLang,
      search: parsed.search,
      hash: parsed.hash,
      isExternal: this._isExternalUrl(url)
    };
  }

  _synthesizeLangUrl(targetLang, context) {
    context = context || this._currentRouteContext;
    
    if (context.isExternal) return context.fullUrl;
    
    var newPath = context.cleanPath;
    if (targetLang !== this.defaultLang) {
      newPath = '/' + targetLang + (context.cleanPath === '/' ? '' : context.cleanPath);
    }
    
    return newPath + context.search + context.hash;
  }

  _isExternalUrl(url) {
    if (!url) return false;
    return url.indexOf('http') === 0 || url.indexOf('//') === 0 || url.indexOf('mailto:') === 0 || url.indexOf('tel:') === 0;
  }

  /* ==================== INITIALIZATION ==================== */

  init() {
    var self = this;
    
    if (this._initialized) {
      return Promise.resolve();
    }
    
    return new Promise(function(resolve, reject) {
      try {
        self._preconnect();
        
        Promise.all([
          self._loadCSS(),
          self._fetchConfig()
        ]).then(function(results) {
          self._config = results[1];
          self._setupHistoryApi();
          
          var fragment = self._createNavigationItemsFragment();
          self._injectNavigation(fragment);
          
          self._navEl = document.querySelector('.bottom-nav');
          if (!self._navEl) {
            throw new Error('Navigation element not created');
          }

          self._navEl.style.willChange = 'transform';
          
          self._bindBaseListeners();
          self._setupPrefetchListeners();
          self._updateActiveState();
          self._applyScreenBehavior();
          self._syncHtmlLangAttribute();
          
          self._initialized = true;
          
          window.dispatchEvent(new CustomEvent('modernNavReady', {
            detail: { lang: self.currentLang, nav: self }
          }));
          
          resolve();
        }).catch(function(err) {
          self._cleanup();
          console.error('ModernNavigation init error:', err);
          reject(err);
        });
        
      } catch (err) {
        self._cleanup();
        console.error('ModernNavigation init error:', err);
        reject(err);
      }
    });
  }

  _preconnect() {
    try {
      var url = new URL(this.configPath, location.origin);
      var selector = 'link[rel="preconnect"][href="' + url.origin + '"]';
      if (!document.querySelector(selector)) {
        var link = document.createElement('link');
        link.rel = 'preconnect';
        link.href = url.origin;
        document.head.appendChild(link);
      }
    } catch (e) {}
  }

  _loadCSS() {
    var self = this;
    return new Promise(function(resolve) {
      if (document.querySelector('link[href="' + self.cssPath + '"]')) {
        resolve();
        return;
      }
      var link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = self.cssPath;
      link.onload = function() { resolve(); };
      link.onerror = function() { resolve(); };
      document.head.appendChild(link);
    });
  }

  _fetchConfig() {
    var self = this;
    return fetch(this.configPath, { 
      cache: 'no-store', 
      credentials: 'same-origin' 
    }).then(function(res) {
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return res.json();
    }).catch(function(e) {
      return { navigation: [] };
    });
  }

  _setupHistoryApi() {
    var self = this;
    var originalPushState = history.pushState;
    var originalReplaceState = history.replaceState;
    
    history.pushState = function(state, title, url) {
      var enhancedState = state || {};
      enhancedState._modernNav = {
        lang: self.currentLang,
        timestamp: Date.now(),
        scrollPos: window.scrollY
      };
      return originalPushState.call(this, enhancedState, title, url);
    };
    
    history.replaceState = function(state, title, url) {
      var enhancedState = state || {};
      enhancedState._modernNav = {
        lang: self.currentLang,
        timestamp: Date.now(),
        scrollPos: window.scrollY
      };
      return originalReplaceState.call(this, enhancedState, title, url);
    };
  }

  /* ==================== SMART ROUTING ==================== */

  _isNavLinkActive(navLink, currentContext) {
    currentContext = currentContext || this._currentRouteContext;
    if (!navLink || navLink === '#') return false;
    
    var navContext = this._parseRouteContext(navLink);
    if (navContext.isExternal) return false;
    
    var currentClean = currentContext.cleanPath.replace(/\/$/, '') || '/';
    var navClean = navContext.cleanPath.replace(/\/$/, '') || '/';
    
    if (currentClean === navClean) return true;
    if (currentClean.indexOf(navClean + '/') === 0 && navClean !== '/') return true;
    if (navClean === '/' && (currentClean === '/' || currentClean === '/index.html')) return true;
    
    return false;
  }

  _generateSmartHref(baseUrl, targetLang) {
    targetLang = targetLang || this.currentLang;
    
    if (this._isExternalUrl(baseUrl)) {
      return baseUrl;
    }
    
    var baseContext = this._parseRouteContext(baseUrl);
    return this._synthesizeLangUrl(targetLang, baseContext);
  }

  /* ==================== PREFETCHING ==================== */

  _setupPrefetchListeners() {
    if (!this.enablePrefetch || !this._navEl) return;
    this._navEl.addEventListener('mouseenter', this._onPrefetchHoverBound, true);
    this._navEl.addEventListener('touchstart', this._onPrefetchTouchBound, { passive: true });
  }

  _onPrefetchHover(event) {
    var self = this;
    var item = event.target.closest(this.navItemSelector);
    if (!item) return;
    
    var href = item.getAttribute('href');
    if (!href || this._isExternalUrl(href) || this._prefetchCache.has(href)) {
      return;
    }
    
    item._prefetchTimeout = setTimeout(function() {
      self._prefetchPage(href);
    }, this.prefetchDelay);
    
    var cancelHandler = function() {
      if (item._prefetchTimeout) {
        clearTimeout(item._prefetchTimeout);
      }
    };
    
    item.addEventListener('mouseleave', cancelHandler, { once: true });
  }

  _onPrefetchTouch(event) {
    var item = event.target.closest(this.navItemSelector);
    if (!item) return;
    
    var href = item.getAttribute('href');
    if (!href || this._isExternalUrl(href)) return;
    
    this._prefetchPage(href);
  }

  _prefetchPage(url) {
    var self = this;
    
    if (this._prefetchCache.has(url) || this._isExternalUrl(url)) {
      return Promise.resolve();
    }
    
    return fetch(url, {
      method: 'GET',
      credentials: 'same-origin',
      headers: { 'X-ModernNav-Prefetch': '1' }
    }).then(function(response) {
      if (response.ok) {
        return response.text();
      }
      throw new Error('Prefetch failed');
    }).then(function(html) {
      var titleMatch = html.match(/<title[^>]*>([^<]*)<\/title>/i);
      self._prefetchCache.set(url, {
        html: html,
        timestamp: Date.now(),
        title: titleMatch ? titleMatch[1] : ''
      });
    }).catch(function() {
      // Silently fail
    });
  }

  /* ==================== DOM BUILDING ==================== */

  _createNavigationItemsFragment() {
    var fragment = document.createDocumentFragment();
    var config = (this._config && this._config.navigation) ? this._config.navigation : [];
    var lang = this.currentLang;
    var self = this;

    config.forEach(function(item) {
      var link = document.createElement('a');
      link.className = 'nav-item ' + (item.customClass || self.defaultButtonClass);
      
      var baseUrl = item.go_url || item.url || '#';
      var smartHref = self._generateSmartHref(baseUrl, self.currentLang);
      link.href = smartHref;
      
      link.dataset.baseUrl = baseUrl;
      link.dataset.isExternal = self._isExternalUrl(baseUrl);
      link.setAttribute('role', 'menuitem');
      link.setAttribute('wave-delegate', '.svg-wrapper');
      
      if (self.enablePrefetch && !link.dataset.isExternal) {
        link.dataset.prefetch = 'true';
      }

      if (item.icon) {
        var tmp = document.createElement('div');
        tmp.innerHTML = item.icon;
        var wrapper = document.createElement('span');
        wrapper.className = 'svg-wrapper';
        wrapper.setAttribute('wave', '');
        
        while (tmp.firstChild) {
          wrapper.appendChild(tmp.firstChild);
        }
        link.appendChild(wrapper);
      }

      var label = document.createElement('div');
      label.className = 'label';
      label.textContent = item[lang + '_label'] || item.en_label || 'Missing Label';
      link.appendChild(label);
      
      fragment.appendChild(link);
    });
    
    return fragment;
  }

  _injectNavigation(fragment) {
    if (document.querySelector('.bottom-nav')) return;
    var nav = document.createElement('div');
    nav.className = 'bottom-nav';
    nav.setAttribute('role', 'navigation');
    nav.appendChild(fragment);
    document.body.insertBefore(nav, document.body.firstChild);
  }

  /* ==================== EVENT HANDLING ==================== */

  _bindBaseListeners() {
    var self = this;
    if (!this._navEl) return;

    this._navEl.addEventListener('click', this._onNavClickBound, { passive: false });
    window.addEventListener('scroll', this._scrollHandler, { passive: true });
    window.addEventListener('storage', this._storageHandler);
    window.addEventListener('modernNavCommand', this._onExternalCommandBound);
    window.addEventListener('popstate', this._onPopStateBound);

    window.addEventListener('languageChange', function(e) {
      if (e && e.detail && e.detail.language) {
        self.switchLanguage(e.detail.language, { updateUrl: true });
      }
    });

    // Override localStorage
    localStorage.setItem = function(key, value) {
      self._originalSetItem(key, value);
      if (key === 'selectedLang' && value !== self.currentLang) {
        self.switchLanguage(value, { updateUrl: true, source: 'storage' });
      }
    };

    document.addEventListener('visibilitychange', function() {
      if (!document.hidden) {
        self._currentRouteContext = self._parseRouteContext(window.location.href);
        self._updateActiveState();
      }
    });
  }

  _unbindBaseListeners() {
    if (!this._navEl) return;
    this._navEl.removeEventListener('click', this._onNavClickBound);
    window.removeEventListener('scroll', this._scrollHandler);
    window.removeEventListener('storage', this._storageHandler);
    window.removeEventListener('modernNavCommand', this._onExternalCommandBound);
    window.removeEventListener('popstate', this._onPopStateBound);
    
    if (this.enablePrefetch && this._navEl) {
      this._navEl.removeEventListener('mouseenter', this._onPrefetchHoverBound, true);
      this._navEl.removeEventListener('touchstart', this._onPrefetchTouchBound);
    }
    
    try { 
      localStorage.setItem = this._originalSetItem; 
    } catch(e) {}
  }

  _onNavClick(event) {
    var item = event.target.closest(this.navItemSelector);
    if (!item) return;

    var href = item.getAttribute('href');
    var baseUrl = item.dataset.baseUrl;
    var isExternal = item.dataset.isExternal === 'true';

    if (isExternal || !href || href.charAt(0) === '#') {
      return;
    }

    if (item.classList.contains(this.activeClass)) {
      event.preventDefault();
      return;
    }

    var targetContext = this._parseRouteContext(href);
    if (targetContext.cleanPath === this._currentRouteContext.cleanPath && 
        targetContext.lang !== this._currentRouteContext.lang) {
      event.preventDefault();
      this.switchLanguage(targetContext.lang, { 
        path: targetContext.cleanPath,
        preserveScroll: true 
      });
      return;
    }

    event.preventDefault();
    this._performNavigation(href, {
      baseUrl: baseUrl,
      trigger: 'click',
      sourceElement: item
    });
  }

  _onPopState(event) {
    var self = this;
    var state = event.state;
    
    if (state && state._modernNav) {
      var savedLang = state._modernNav.lang;
      if (savedLang && savedLang !== this.currentLang) {
        this.currentLang = savedLang;
        localStorage.setItem('selectedLang', savedLang);
        this._updateLabels(savedLang);
        this._syncHtmlLangAttribute();
      }
      
      if (typeof state._modernNav.scrollPos === 'number') {
        setTimeout(function() {
          window.scrollTo(0, state._modernNav.scrollPos);
        }, 0);
      }
    }
    
    this._currentRouteContext = this._parseRouteContext(window.location.href);
    this._updateActiveState();
    this._updateAllNavUrls();
  }

  /* ==================== NAVIGATION CORE ==================== */

  _performNavigation(url, options) {
    var self = this;
    options = options || {};
    
    if (this._isNavigating) return Promise.resolve();
    this._isNavigating = true;

    var cached = this._prefetchCache.get(url);
    
    var navigatePromise;
    
    if (cached && this.enableSmoothTransition) {
      navigatePromise = this._transitionToContent(url, cached.html, options);
    } else if (this.enableSmoothTransition) {
      navigatePromise = this._smoothNavigate(url, options);
    } else {
      window.location.href = url;
      return Promise.resolve();
    }

    return navigatePromise.then(function() {
      self._currentRouteContext = self._parseRouteContext(url);
      self.currentLang = self._currentRouteContext.lang;
      localStorage.setItem('selectedLang', self.currentLang);
      
      self._updateActiveState();
      self._syncHtmlLangAttribute();
      history.pushState({}, '', url);
      
      window.dispatchEvent(new CustomEvent('modernNavRouteChanged', {
        detail: {
          url: url,
          lang: self.currentLang,
          method: cached ? 'prefetch' : 'fetch'
        }
      }));
      
      self._isNavigating = false;
    }).catch(function(err) {
      console.error('[ModernNav] Navigation failed:', err);
      window.location.href = url;
      self._isNavigating = false;
    });
  }

  _transitionToContent(url, html, options) {
    var self = this;
    
    return new Promise(function(resolve) {
      if (!self.enableSmoothTransition) {
        self._injectNewPageContent(html);
        resolve();
        return;
      }

      var overlay = document.createElement('div');
      overlay.className = 'modern-nav-transition-overlay';
      overlay.style.cssText = [
        'position: fixed',
        'top: 0',
        'left: 0',
        'right: 0',
        'bottom: 0',
        'background: #fff',
        'opacity: 0',
        'transition: opacity ' + self.transitionDuration + 'ms ease',
        'z-index: 99999',
        'pointer-events: none'
      ].join(';');

      document.body.appendChild(overlay);
      
      requestAnimationFrame(function() {
        overlay.style.opacity = '1';
        
        setTimeout(function() {
          self._injectNewPageContent(html);
          overlay.style.opacity = '0';
          
          setTimeout(function() {
            overlay.remove();
            resolve();
          }, self.transitionDuration);
        }, self.transitionDuration);
      });
    });
  }

  _injectNewPageContent(html) {
    var parser = new DOMParser();
    var newDoc = parser.parseFromString(html, 'text/html');
    
    if (newDoc.title) {
      document.title = newDoc.title;
    }
    
    var nav = document.querySelector('.bottom-nav');
    var childrenToRemove = [];
    
    for (var i = 0; i < document.body.children.length; i++) {
      var child = document.body.children[i];
      if (child !== nav) {
        childrenToRemove.push(child);
      }
    }
    
    childrenToRemove.forEach(function(child) {
      child.remove();
    });
    
    var newChildren = [];
    for (var j = 0; j < newDoc.body.children.length; j++) {
      newChildren.push(newDoc.body.children[j]);
    }
    
    newChildren.forEach(function(child) {
      document.body.appendChild(child);
    });
    
    var scripts = document.body.querySelectorAll('script');
    scripts.forEach(function(oldScript) {
      var newScript = document.createElement('script');
      for (var k = 0; k < oldScript.attributes.length; k++) {
        var attr = oldScript.attributes[k];
        newScript.setAttribute(attr.name, attr.value);
      }
      newScript.textContent = oldScript.textContent;
      oldScript.parentNode.replaceChild(newScript, oldScript);
    });
    
    window.scrollTo(0, 0);
  }

  _smoothNavigate(url, options) {
    var self = this;
    
    return fetch(url, {
      credentials: 'same-origin',
      headers: { 'X-ModernNav-Navigate': '1' }
    }).then(function(response) {
      if (!response.ok) throw new Error('HTTP ' + response.status);
      return response.text();
    }).then(function(html) {
      return self._transitionToContent(url, html, options);
    });
  }

  /* ==================== LANGUAGE SWITCHING ==================== */

  switchLanguage(newLang, options) {
    options = options || {};
    
    if (this.supportedLangs.indexOf(newLang) === -1) {
      console.warn('[ModernNav] Unsupported language: ' + newLang);
      return;
    }

    if (newLang === this.currentLang && !options.force) {
      return;
    }

    this._langSwitchInProgress = true;
    var oldLang = this.currentLang;
    
    var currentPath = options.path || this._currentRouteContext.cleanPath;
    var preserveScroll = options.preserveScroll || false;
    var scrollPos = preserveScroll ? window.scrollY : 0;
    
    var newUrl = this._synthesizeLangUrl(newLang, {
      cleanPath: currentPath,
      search: this._currentRouteContext.search,
      hash: this._currentRouteContext.hash,
      isExternal: false
    });

    this.currentLang = newLang;
    localStorage.setItem('selectedLang', newLang);
    
    this._updateLabels(newLang);
    this._updateAllNavUrls();
    this._syncHtmlLangAttribute();
    
    if (options.updateUrl !== false) {
      history.pushState({
        _modernNav: {
          lang: newLang,
          scrollPos: scrollPos,
          timestamp: Date.now()
        }
      }, '', newUrl);
    }

    window.dispatchEvent(new CustomEvent('modernNavLanguageChanged', {
      detail: {
        oldLang: oldLang,
        newLang: newLang,
        url: newUrl,
        preserveScroll: preserveScroll
      }
    }));

    if (preserveScroll) {
      setTimeout(function() {
        window.scrollTo(0, scrollPos);
      }, 0);
    }

    this._langSwitchInProgress = false;
    this._updateActiveState();
  }

  _syncHtmlLangAttribute() {
    document.documentElement.lang = this.currentLang;
  }

  /* ==================== UI UPDATES ==================== */

  _onScrollForActiveState() {
    var self = this;
    if (this._rafId === null) {
      this._rafId = requestAnimationFrame(function() {
        self._updateActiveState();
        self._rafId = null;
      });
    }
  }

  _updateActiveState() {
    if (!this._navEl) return;
    
    var self = this;
    var items = this._navEl.querySelectorAll(this.navItemSelector);
    
    items.forEach(function(item) {
      var baseUrl = item.dataset.baseUrl;
      var shouldBeActive = self._isNavLinkActive(baseUrl);
      var wasActive = item.classList.contains(self.activeClass);
      
      if (shouldBeActive) {
        item.classList.add(self.activeClass);
      } else {
        item.classList.remove(self.activeClass);
      }
      
      var wrapper = item.querySelector('.svg-wrapper');
      if (wrapper && shouldBeActive && !wasActive) {
        wrapper.classList.remove('animate');
        void wrapper.offsetWidth;
        wrapper.classList.add('animate');
      }
    });
  }

  _updateAllNavUrls() {
    if (!this._navEl) return;
    
    var self = this;
    var items = this._navEl.querySelectorAll(this.navItemSelector);
    
    items.forEach(function(item) {
      var baseUrl = item.dataset.baseUrl;
      if (!baseUrl || item.dataset.isExternal === 'true') return;
      
      var newHref = self._generateSmartHref(baseUrl, self.currentLang);
      item.href = newHref;
    });
  }

  _updateLabels(lang) {
    if (!this._navEl || !this._config || !this._config.navigation) return;
    
    var configMap = {};
    this._config.navigation.forEach(function(n) {
      configMap[n.url] = n;
    });
    
    var items = this._navEl.querySelectorAll(this.navItemSelector);
    var self = this;
    
    items.forEach(function(item) {
      var baseUrl = item.dataset.baseUrl;
      var cfg = configMap[baseUrl];
      if (cfg) {
        var label = item.querySelector('.label');
        if (label) {
          label.textContent = cfg[lang + '_label'] || cfg.en_label || 'Missing Label';
        }
      }
    });
  }

  _onStorageEvent(event) {
    if (event.key === 'selectedLang') {
      var newLang = event.newValue;
      if (newLang && newLang !== this.currentLang) {
        this.switchLanguage(newLang, { updateUrl: true, source: 'storage' });
      }
    }
  }

  /* ==================== EXTERNAL API ==================== */

  _onExternalCommand(event) {
    var detail = event && event.detail ? event.detail : {};
    var command = detail.command;
    var reason = detail.reason || 'unknown';
    var lang = detail.lang;
    var url = detail.url;
    
    switch(command) {
      case 'hide':
        this.hideNav(reason);
        break;
      case 'show':
      case 'restore':
        this.showNav(reason);
        break;
      case 'toggle':
        this.toggleNav(reason);
        break;
      case 'switchLang':
        if (lang) this.switchLanguage(lang, { updateUrl: true });
        break;
      case 'navigate':
        if (url) this._performNavigation(url, { trigger: 'external' });
        break;
      case 'refresh':
        this._updateActiveState();
        this._updateAllNavUrls();
        break;
    }
  }

  hideNav(reason) {
    reason = reason || 'external';
    if (!this._navEl) return;
    this._externalHideRequested = true;
    this._autoScrollSyncEnabled = false;
    this._navEl.style.transform = 'translateZ(0) translateY(100%)';
    this._navVisible = false;
    this._dispatchNavStateEvent('hidden', reason);
  }

  showNav(reason) {
    reason = reason || 'external';
    if (!this._navEl) return;
    this._externalHideRequested = false;
    this._autoScrollSyncEnabled = true;
    this._navEl.style.transform = 'translateZ(0) translateY(0%)';
    this._navVisible = true;
    this._dispatchNavStateEvent('shown', reason);
  }

  toggleNav(reason) {
    if (this._externalHideRequested || !this._navVisible) {
      this.showNav(reason);
    } else {
      this.hideNav(reason);
    }
  }

  isNavVisible() {
    return this._navVisible && !this._externalHideRequested;
  }

  _dispatchNavStateEvent(state, reason) {
    window.dispatchEvent(new CustomEvent('modernNavStateChanged', {
      detail: { 
        state: state, 
        reason: reason, 
        visible: this._navVisible, 
        lang: this.currentLang 
      }
    }));
  }

  /* ==================== RESPONSIVE BEHAVIOR ==================== */

  _isMobileScreen() {
    return window.innerWidth < 768;
  }

  _applyScreenBehavior() {
    var isMobile = this._isMobileScreen();
    
    if (this._navEl) {
      if (isMobile) {
        this._navEl.classList.remove('vertical');
      } else {
        this._navEl.classList.add('vertical');
      }
    }

    if (isMobile) {
      this._unmountLeftRailIfMounted();
      this._enableScrollNavSync();
    } else {
      this._mountLeftRailIfNeeded();
      this._disableScrollNavSync();
    }
  }

  _mountLeftRailIfNeeded() {
    if (!this._navEl || document.body.classList.contains('has-left-rail')) return;

    var nav = this._navEl;
    var siteMain = document.createElement('div');
    siteMain.className = 'site-main';

    var nodes = Array.prototype.slice.call(document.body.childNodes);
    for (var i = 0; i < nodes.length; i++) {
      var node = nodes[i];
      if (node !== nav) {
        siteMain.appendChild(node);
      }
    }
    
    document.body.appendChild(siteMain);
    document.body.classList.add('has-left-rail');

    document.documentElement.style.setProperty('--left-rail-width', this.leftRailWidth);
    document.documentElement.style.setProperty('--left-rail-collapsed-width', this.leftRailCollapsedWidth);

    nav.style.position = 'fixed';
    nav.style.top = '0';
    nav.style.left = '0';
    nav.style.transform = 'none';
    nav.style.zIndex = '1000';
    nav.style.height = '100vh';
    nav.style.overflow = 'auto';

    siteMain.style.marginLeft = this.leftRailWidth;
  }

  _unmountLeftRailIfMounted() {
    if (!this._navEl || !document.body.classList.contains('has-left-rail')) return;
    
    var nav = this._navEl;
    var siteMain = document.querySelector('.site-main');
    
    if (siteMain) {
      var children = Array.prototype.slice.call(siteMain.childNodes);
      for (var i = 0; i < children.length; i++) {
        document.body.insertBefore(children[i], siteMain);
      }
      siteMain.remove();
    }

    document.body.classList.remove('has-left-rail');
    document.documentElement.style.removeProperty('--left-rail-width');
    document.documentElement.style.removeProperty('--left-rail-collapsed-width');

    nav.style.position = '';
    nav.style.top = '';
    nav.style.height = '';
    nav.style.left = '';
    nav.style.transform = '';
    nav.style.zIndex = '16000';
    nav.style.overflow = '';

    var bodyChildren = Array.prototype.slice.call(document.body.children);
    var self = this;
    bodyChildren.forEach(function(el) {
      if (el.style && el.style.marginLeft === self.leftRailWidth) {
        el.style.marginLeft = '';
      }
    });
  }

  _enableScrollNavSync() {
    if (this._navScrollSyncEnabled) return;
    
    window.addEventListener('scroll', this._onUltraScrollNavBound, { passive: true });
    window.addEventListener('touchstart', this._onTouchStartBound, { passive: true });
    window.addEventListener('touchend', this._onTouchEndBound, { passive: true });
    
    if (this._navEl && !this._externalHideRequested) {
      this._navEl.style.transition = 'transform 0.22s cubic-bezier(0.33,1,0.68,1)';
      this._navEl.style.transform = 'translateZ(0) translateY(0%)';
      this._navVisible = true;
    }
    
    this._navScrollSyncEnabled = true;
  }

  _disableScrollNavSync() {
    if (!this._navScrollSyncEnabled) return;
    
    window.removeEventListener('scroll', this._onUltraScrollNavBound);
    window.removeEventListener('touchstart', this._onTouchStartBound);
    window.removeEventListener('touchend', this._onTouchEndBound);
    
    if (this._navEl && !this._externalHideRequested) {
      this._navEl.style.transform = 'translateZ(0) translateY(0%)';
      this._navVisible = true;
    }
    
    this._navScrollSyncEnabled = false;
  }

  _onTouchStart() {
    this._isTouching = true;
    this._lastScrollY = window.scrollY;
  }

  _onTouchEnd() {
    this._isTouching = false;
  }

  _onUltraScrollNav() {
    if (this._externalHideRequested || !this._autoScrollSyncEnabled) return;
    if (!this._navEl) return;
    
    var y = window.scrollY;
    var delta = y - this._lastScrollY;
    this._lastScrollY = y;
    
    if (y <= this.SHOW_THRESHOLD) {
      if (!this._navVisible) this._showNav();
      return;
    }
    
    if (this._isTouching) {
      if (delta > 15 && this._navVisible) {
        this._hideNav();
      } else if (delta < -10 && !this._navVisible) {
        this._showNav();
      }
    }
  }

  _hideNav() {
    if (!this._navEl) return;
    this._navEl.style.transform = 'translateZ(0) translateY(100%)';
    this._navVisible = false;
  }

  _showNav() {
    if (!this._navEl) return;
    this._navEl.style.transform = 'translateZ(0) translateY(0%)';
    this._navVisible = true;
  }

  /* ==================== UTILITIES ==================== */

  _debounce(fn, wait) {
    wait = wait || 100;
    var t = null;
    var self = this;
    return function() {
      var args = arguments;
      clearTimeout(t);
      t = setTimeout(function() {
        fn.apply(self, args);
      }, wait);
    };
  }

  _cleanup() {
    try {
      window.removeEventListener('resize', this._resizeHandler);
      window.removeEventListener('orientationchange', this._orientationHandler);
      window.removeEventListener('scroll', this._scrollHandler);
      window.removeEventListener('storage', this._storageHandler);
      window.removeEventListener('modernNavCommand', this._onExternalCommandBound);
      window.removeEventListener('popstate', this._onPopStateBound);
      this._disableScrollNavSync();
      
      try { 
        localStorage.setItem = this._originalSetItem; 
      } catch(e) {}
    } catch(e) {}
    
    this._initialized = false;
    this._navEl = null;
  }

  destroy() {
    this._cleanup();
  }

  /* ==================== PUBLIC API ==================== */

  navigateTo(url, options) {
    return this._performNavigation(url, options);
  }

  getState() {
    return {
      lang: this.currentLang,
      route: this._currentRouteContext,
      isVisible: this.isNavVisible(),
      history: this._navigationHistory
    };
  }

  prefetch(url) {
    return this._prefetchPage(url);
  }

  clearCache() {
    this._prefetchCache.clear();
  }
}

/* ==================== BOOTSTRAP ==================== */
(function(){
  var nav = new ModernNavigation({
    cssPath: '/assets/css/modern-styles.min.css',
    configPath: '/assets/json/template/template.min.json',
    defaultButtonClass: 'default-button',
    leftRailWidth: '88px',
    leftRailCollapsedWidth: '72px',
    defaultLang: 'en',
    supportedLangs: ['th', 'en', 'ja', 'ko', 'zh', 'fr', 'de', 'es', 'it', 'pt', 'ru', 'ar', 'vi', 'id', 'ms', 'tl'],
    enablePrefetch: true,
    prefetchDelay: 100,
    enableSmoothTransition: true,
    transitionDuration: 200
  });

  if (typeof queueMicrotask === 'function') {
    queueMicrotask(function() {
      nav.init().catch(function(e) {
        console.error('ModernNavigation init failed:', e);
      });
    });
  } else {
    setTimeout(function() {
      nav.init().catch(function(e) {
        console.error('ModernNavigation init failed:', e);
      });
    }, 0);
  }

  window.modernNav = nav;
  
  window.addEventListener('load', function() {
    var detectedLang = nav._detectCurrentLanguage();
    if (detectedLang !== nav.currentLang) {
      nav.switchLanguage(detectedLang, { updateUrl: false, force: true });
    }
  });
})();
