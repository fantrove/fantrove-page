<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantrove Console</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #252525;
            --border-color: #333;
            --text-primary: #e0e0e0;
            --text-secondary: #888;
            --accent-blue: #4a9eff;
            --accent-green: #4caf50;
            --accent-yellow: #ff9800;
            --accent-red: #f44336;
            --accent-purple: #9c27b0;
            --font-mono: 'SF Mono', Monaco, 'Cascadia Code', monospace;
        }

        body {
            font-family: var(--font-mono);
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-green);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo::before {
            content: '‚óâ';
            color: var(--accent-blue);
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-family: inherit;
            transition: all 0.2s;
        }

        .btn:hover {
            background: var(--border-color);
        }

        .btn.danger {
            color: var(--accent-red);
        }

        .btn.danger:hover {
            background: rgba(244, 67, 54, 0.1);
        }

        /* Filters */
        .filters {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 8px 16px;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .filter-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-family: inherit;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .filter-btn.active {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .filter-btn.error.active { color: var(--accent-red); border-color: var(--accent-red); }
        .filter-btn.warn.active { color: var(--accent-yellow); border-color: var(--accent-yellow); }
        .filter-btn.info.active { color: var(--accent-blue); border-color: var(--accent-blue); }
        .filter-btn.success.active { color: var(--accent-green); border-color: var(--accent-green); }

        .badge {
            background: var(--bg-primary);
            padding: 1px 5px;
            border-radius: 10px;
            font-size: 10px;
            min-width: 18px;
            text-align: center;
        }

        /* Console Output */
        .console-container {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
        }

        .console-container::-webkit-scrollbar {
            width: 8px;
        }

        .console-container::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        .console-container::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        .log-entry {
            padding: 6px 16px;
            border-left: 3px solid transparent;
            font-size: 12px;
            line-height: 1.5;
            display: flex;
            gap: 12px;
            animation: fadeIn 0.2s ease;
            position: relative;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-5px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .log-entry:hover {
            background: var(--bg-secondary);
        }

        .log-entry.error { border-left-color: var(--accent-red); }
        .log-entry.warn { border-left-color: var(--accent-yellow); }
        .log-entry.info { border-left-color: var(--accent-blue); }
        .log-entry.success { border-left-color: var(--accent-green); }
        .log-entry.debug { border-left-color: var(--accent-purple); }

        .log-time {
            color: var(--text-secondary);
            font-size: 11px;
            white-space: nowrap;
            user-select: none;
        }

        .log-source {
            color: var(--accent-purple);
            font-size: 11px;
            white-space: nowrap;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .log-message {
            flex: 1;
            word-break: break-word;
        }

        .log-entry.error .log-message { color: #ff6b6b; }
        .log-entry.warn .log-message { color: #ffd166; }
        .log-entry.info .log-message { color: #118ab2; }
        .log-entry.success .log-message { color: #06d6a0; }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            gap: 12px;
        }

        .empty-icon {
            font-size: 48px;
            opacity: 0.3;
        }

        /* Input Area */
        .input-area {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            padding: 12px 16px;
        }

        .input-hint {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }

        .input-box {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 8px 12px;
            font-family: inherit;
            font-size: 12px;
            color: var(--text-primary);
            width: 100%;
            outline: none;
        }

        .input-box:focus {
            border-color: var(--accent-blue);
        }

        /* Status Bar */
        .status-bar {
            background: var(--bg-tertiary);
            border-top: 1px solid var(--border-color);
            padding: 4px 16px;
            font-size: 11px;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
        }

        .status-item {
            display: flex;
            gap: 16px;
        }

        /* Connection Status */
        .connection-status {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .connection-status.connected::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--accent-green);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* API Info Panel */
        .api-info {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 12px 16px;
            font-size: 11px;
        }

        .api-info code {
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 3px;
            color: var(--accent-yellow);
            font-family: var(--font-mono);
        }

        .api-info details {
            margin-top: 8px;
        }

        .api-info summary {
            cursor: pointer;
            color: var(--accent-blue);
            user-select: none;
        }

        .api-info pre {
            margin-top: 8px;
            padding: 12px;
            background: var(--bg-primary);
            border-radius: 4px;
            overflow-x: auto;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">Fantrove Console</div>
        <div class="header-actions">
            <button class="btn" onclick="consoleSystem.exportLogs()">üìã Export</button>
            <button class="btn danger" onclick="consoleSystem.clear()">Clear</button>
        </div>
    </div>

    <div class="api-info">
        <strong>üí° API Usage:</strong> Use <code>FantroveConsole.log()</code> from any page to send logs here.
        <details>
            <summary>View Integration Code</summary>
            <pre>// Include this in your main website
&lt;script src="fantrove-console-api.js"&gt;&lt;/script&gt;

// Then use anywhere:
FantroveConsole.error('Database connection failed');
FantroveConsole.warn('Slow response time');
FantroveConsole.info('User logged in', { userId: 123 });
FantroveConsole.success('Payment completed');</pre>
        </details>
    </div>

    <div class="filters">
        <button class="filter-btn active" data-level="all" onclick="consoleSystem.filter('all')">
            All <span class="badge" id="count-all">0</span>
        </button>
        <button class="filter-btn error active" data-level="error" onclick="consoleSystem.filter('error')">
            Errors <span class="badge" id="count-error">0</span>
        </button>
        <button class="filter-btn warn active" data-level="warn" onclick="consoleSystem.filter('warn')">
            Warnings <span class="badge" id="count-warn">0</span>
        </button>
        <button class="filter-btn info active" data-level="info" onclick="consoleSystem.filter('info')">
            Info <span class="badge" id="count-info">0</span>
        </button>
        <button class="filter-btn success active" data-level="success" onclick="consoleSystem.filter('success')">
            Success <span class="badge" id="count-success">0</span>
        </button>
        <button class="filter-btn active" data-level="debug" onclick="consoleSystem.filter('debug')">
            Debug <span class="badge" id="count-debug">0</span>
        </button>
    </div>

    <div class="console-container" id="console-output">
        <div class="empty-state">
            <div class="empty-icon">üì≠</div>
            <div>Waiting for logs... Open your website in another tab and call FantroveConsole.log()</div>
        </div>
    </div>

    <div class="input-area">
        <div class="input-hint">
            <span>Quick Test: Type message and press Enter</span>
            <span style="color: var(--text-secondary)">Logs auto-clear after 7 days</span>
        </div>
        <input type="text" class="input-box" id="test-input" placeholder="Type test message..." 
               onkeypress="if(event.key==='Enter')consoleSystem.testLog(this.value)">
    </div>

    <div class="status-bar">
        <div class="status-item">
            <span class="connection-status connected" id="conn-status">Listening</span>
            <span>Tab ID: <span id="tab-id">--</span></span>
            <span>Logs: <span id="total-logs">0</span></span>
        </div>
        <div class="status-item">
            <span>Auto-cleanup: 7 days</span>
            <span id="storage-used">--</span>
        </div>
    </div>

    <script>
        /**
         * Fantrove Console System
         * Simple logging hub for external systems
         */
        class FantroveConsoleSystem {
            constructor() {
                this.logs = [];
                this.activeFilters = new Set(['error', 'warn', 'info', 'success', 'debug']);
                this.tabId = this.generateTabId();
                this.storageKey = `fantrove_console_${this.tabId}`;
                this.cleanupOldLogs();
                this.init();
            }

            init() {
                // Display tab ID
                document.getElementById('tab-id').textContent = this.tabId.substring(0, 8);
                
                // Load existing logs for this tab
                this.loadLogs();
                
                // Listen for messages from other windows/tabs
                this.setupMessageListener();
                
                // Listen for storage changes (cross-tab communication)
                this.setupStorageListener();
                
                // Update storage usage
                this.updateStorageInfo();
                
                // Initial message
                this.info('Console ready', 'System');
            }

            generateTabId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }

            // Storage management with 7-day TTL
            cleanupOldLogs() {
                const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
                
                // Clean this tab's logs
                const key = this.storageKey;
                const data = localStorage.getItem(key);
                if (data) {
                    try {
                        const parsed = JSON.parse(data);
                        const filtered = parsed.filter(log => log.timestamp > sevenDaysAgo);
                        localStorage.setItem(key, JSON.stringify(filtered));
                    } catch (e) {
                        localStorage.removeItem(key);
                    }
                }

                // Clean other old console logs
                Object.keys(localStorage).forEach(k => {
                    if (k.startsWith('fantrove_console_')) {
                        try {
                            const data = JSON.parse(localStorage.getItem(k));
                            if (data.length === 0 || data[0].timestamp < sevenDaysAgo) {
                                localStorage.removeItem(k);
                            }
                        } catch (e) {
                            localStorage.removeItem(k);
                        }
                    }
                });
            }

            saveLogs() {
                localStorage.setItem(this.storageKey, JSON.stringify(this.logs));
                this.updateStorageInfo();
            }

            loadLogs() {
                const data = localStorage.getItem(this.storageKey);
                if (data) {
                    try {
                        const parsed = JSON.parse(data);
                        parsed.forEach(log => this.renderLog(log));
                        this.logs = parsed;
                        this.updateCounts();
                    } catch (e) {
                        console.error('Failed to load logs:', e);
                    }
                }
            }

            // Cross-tab communication via localStorage
            setupStorageListener() {
                window.addEventListener('storage', (e) => {
                    if (e.key === 'fantrove_console_broadcast') {
                        try {
                            const data = JSON.parse(e.newValue);
                            if (data && data.tabId !== this.tabId) {
                                this.receiveLog(data);
                            }
                        } catch (err) {
                            // Ignore invalid data
                        }
                    }
                });
            }

            // Window message API (for iframe/postMessage)
            setupMessageListener() {
                window.addEventListener('message', (e) => {
                    if (e.data && e.data.type === 'FANTROVE_LOG') {
                        this.receiveLog(e.data.payload);
                    }
                });
            }

            // Receive log from external source
            receiveLog(logData) {
                const log = {
                    id: Date.now() + Math.random(),
                    timestamp: Date.now(),
                    level: logData.level || 'info',
                    message: logData.message,
                    source: logData.source || 'External',
                    meta: logData.meta || null
                };

                this.logs.push(log);
                if (this.logs.length > 500) this.logs.shift(); // Keep last 500
                
                this.saveLogs();
                
                if (this.shouldDisplay(log)) {
                    this.renderLog(log);
                }
                this.updateCounts();
            }

            // Public API methods (called from external scripts)
            static log(message, meta, source) {
                this.send('log', message, meta, source);
            }

            static error(message, meta, source) {
                this.send('error', message, meta, source);
            }

            static warn(message, meta, source) {
                this.send('warn', message, meta, source);
            }

            static info(message, meta, source) {
                this.send('info', message, meta, source);
            }

            static success(message, meta, source) {
                this.send('success', message, meta, source);
            }

            static debug(message, meta, source) {
                this.send('debug', message, meta, source);
            }

            static send(level, message, meta, source) {
                const payload = {
                    level,
                    message: typeof message === 'object' ? JSON.stringify(message) : String(message),
                    meta,
                    source: source || 'Unknown',
                    tabId: 'broadcast',
                    time: Date.now()
                };

                // Broadcast to all tabs via localStorage
                try {
                    localStorage.setItem('fantrove_console_broadcast', JSON.stringify(payload));
                } catch (e) {
                    // Storage might be full
                }

                // Also try direct parent/opener
                if (window.opener) {
                    window.opener.postMessage({ type: 'FANTROVE_LOG', payload }, '*');
                }
            }

            // Internal log (for console page itself)
            log(message, source = 'Console') {
                this.receiveLog({ level: 'log', message, source });
            }

            error(message, source = 'Console') {
                this.receiveLog({ level: 'error', message, source });
            }

            warn(message, source = 'Console') {
                this.receiveLog({ level: 'warn', message, source });
            }

            info(message, source = 'Console') {
                this.receiveLog({ level: 'info', message, source });
            }

            success(message, source = 'Console') {
                this.receiveLog({ level: 'success', message, source });
            }

            debug(message, source = 'Console') {
                this.receiveLog({ level: 'debug', message, source });
            }

            shouldDisplay(log) {
                return this.activeFilters.has(log.level);
            }

            renderLog(log) {
                const output = document.getElementById('console-output');
                
                // Remove empty state if exists
                if (output.querySelector('.empty-state')) {
                    output.innerHTML = '';
                }

                const entry = document.createElement('div');
                entry.className = `log-entry ${log.level}`;
                
                const time = new Date(log.timestamp).toLocaleTimeString('en-GB', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                const metaStr = log.meta ? ` ${JSON.stringify(log.meta)}` : '';
                
                entry.innerHTML = `
                    <span class="log-time">${time}</span>
                    <span class="log-source" title="${log.source}">${log.source}</span>
                    <span class="log-message">${this.escapeHtml(log.message)}${this.escapeHtml(metaStr)}</span>
                `;

                output.appendChild(entry);
                output.scrollTop = output.scrollHeight;
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            filter(level) {
                if (level === 'all') {
                    const allActive = this.activeFilters.size === 5;
                    document.querySelectorAll('.filter-btn[data-level]').forEach(btn => {
                        if (allActive) {
                            this.activeFilters.clear();
                            btn.classList.remove('active');
                        } else {
                            this.activeFilters.add(btn.dataset.level);
                            btn.classList.add('active');
                        }
                    });
                } else {
                    const btn = document.querySelector(`[data-level="${level}"]`);
                    if (this.activeFilters.has(level)) {
                        this.activeFilters.delete(level);
                        btn.classList.remove('active');
                    } else {
                        this.activeFilters.add(level);
                        btn.classList.add('active');
                    }
                }
                this.refreshDisplay();
            }

            refreshDisplay() {
                const output = document.getElementById('console-output');
                output.innerHTML = '';
                
                const toShow = this.logs.filter(log => this.shouldDisplay(log));
                
                if (toShow.length === 0) {
                    output.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üîç</div>
                            <div>No logs match current filters</div>
                        </div>
                    `;
                } else {
                    toShow.forEach(log => this.renderLog(log));
                }
            }

            updateCounts() {
                const counts = { all: this.logs.length, error: 0, warn: 0, info: 0, success: 0, debug: 0 };
                this.logs.forEach(log => {
                    if (counts[log.level] !== undefined) counts[log.level]++;
                });

                Object.keys(counts).forEach(key => {
                    const el = document.getElementById(`count-${key}`);
                    if (el) el.textContent = counts[key];
                });

                document.getElementById('total-logs').textContent = counts.all;
            }

            updateStorageInfo() {
                let total = 0;
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('fantrove_console_')) {
                        total += localStorage.getItem(key).length;
                    }
                });
                const kb = (total / 1024).toFixed(1);
                document.getElementById('storage-used').textContent = `${kb} KB`;
            }

            clear() {
                this.logs = [];
                localStorage.removeItem(this.storageKey);
                document.getElementById('console-output').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üßπ</div>
                        <div>Console cleared</div>
                    </div>
                `;
                this.updateCounts();
                this.updateStorageInfo();
            }

            exportLogs() {
                const data = {
                    exported: new Date().toISOString(),
                    tabId: this.tabId,
                    logs: this.logs
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `fantrove-logs-${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }

            testLog(value) {
                if (!value.trim()) return;
                this.log(value, 'Test');
                document.getElementById('test-input').value = '';
            }
        }

        // Initialize
        window.consoleSystem = new FantroveConsoleSystem();

        // Expose global API for external use
        window.FantroveConsole = {
            log: (msg, meta, src) => FantroveConsoleSystem.log(msg, meta, src),
            error: (msg, meta, src) => FantroveConsoleSystem.error(msg, meta, src),
            warn: (msg, meta, src) => FantroveConsoleSystem.warn(msg, meta, src),
            info: (msg, meta, src) => FantroveConsoleSystem.info(msg, meta, src),
            success: (msg, meta, src) => FantroveConsoleSystem.success(msg, meta, src),
            debug: (msg, meta, src) => FantroveConsoleSystem.debug(msg, meta, src)
        };

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            // Optional: Clear logs if wanted, but we keep them for persistence
        });
    </script>
</body>
</html>
